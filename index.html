<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Worker Schedule Board</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        
        .start-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: -20px;
            padding: 20px;
        }
        
        .start-container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 100%;
        }
        
        .start-header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #333;
            font-weight: 700;
        }
        
        .start-subtitle {
            font-size: 18px;
            color: #666;
            margin-bottom: 40px;
        }
        
        .start-actions {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .btn-start-primary, .btn-start-secondary {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            font-family: inherit;
        }
        
        .btn-start-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }
        
        .btn-start-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }
        
        .btn-start-secondary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }
        
        .btn-start-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.3);
        }
        
        .btn-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .btn-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .btn-desc {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .start-footer {
            color: #888;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            background: #f4e4a1;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #e0d090;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 15px;
        }
        
        .header-inputs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .header-input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .header-input-group label {
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }
        
        .header-input-group input {
            padding: 6px 12px;
            border: 2px solid #d0c080;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            text-align: center;
            min-width: 120px;
            transition: border-color 0.2s;
        }
        
        .header-input-group input:focus {
            outline: none;
            border-color: #b8a060;
            background: #fffef8;
        }
        
        .header .subtitle {
            font-size: 18px;
            color: #666;
        }
        
        .header .update-date {
            font-size: 14px;
            color: #888;
            margin-top: 5px;
        }
        
        .main-content {
            display: flex;
            height: calc(100vh - 200px);
            min-height: 800px;
        }
        
        .sidebar {
            width: 280px;
            background: #fafafa;
            border-right: 2px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
        }
        
        .worker-category {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            min-height: 60px;
            transition: all 0.3s;
        }
        
        .worker-category.drag-over {
            background: #e3f2fd;
            border-color: #2196F3;
            transform: scale(1.02);
        }
        
        .worker-category h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #333;
        }
        
        .worker-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            background: white;
        }
        
        .worker-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .worker-item.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }
        
        .worker-item.selected {
            border: 2px solid #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .worker-name {
            font-weight: 600;
            font-size: 13px;
        }
        
        .worker-hours {
            font-size: 11px;
            color: #666;
        }
        
        .delete-worker {
            background: #ff4444;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .schedule-container {
            flex: 1;
            padding: 20px;
            overflow: auto;
            position: relative;
        }
        
        .schedule-container * {
            position: relative;
        }
        
        /* Fix grid overflow for multi-hour blocks */
        .schedule-grid {
            display: grid;
            grid-template-columns: 75px repeat(7, 1fr);
            grid-template-rows: 40px repeat(31, 30px);
            gap: 1px;
            background: #ddd;
            border: 1px solid #ddd;
            min-width: 950px;
            position: relative;
            isolation: isolate;
        }
        
        /* Allow cells to show content that overflows */
        .schedule-cell {
            background: white;
            position: relative;
            cursor: pointer;
            padding: 1px;
            min-height: 30px;
            overflow: visible !important;
        }
        
        .schedule-cell:hover {
            background: #f0f8ff;
        }
        
        /* Grid headers */
        .time-header {
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .day-header {
            background: #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 2px solid #ccc;
        }
        
        .time-label {
            background: #f8f8f8;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #666;
            border-right: 2px solid #ccc;
            padding: 0 2px;
        }
        
        .shift-block {
            min-width: 35px;
            padding: 3px 2px;
            border-radius: 4px;
            font-size: 8px;
            font-weight: 600;
            color: #111;
            cursor: move;
            border: 2px solid rgba(0,0,0,0.25);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            overflow: visible;
            transition: all 0.2s;
            position: absolute;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            line-height: 1.1;
            background-image: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 50%);
            z-index: 50;
            top: 1px;
            height: calc(100% - 4px);
            max-width: 140px;
            word-break: break-word;
        }
        
        .shift-block.narrow {
            padding: 2px 1px;
        }
        
        .shift-block:hover {
            z-index: 1000 !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: scale(1.02);
        }
        
        .shift-block.multi-hour {
            padding: 6px 4px;
            justify-content: space-between;
            min-height: 50px;
            z-index: 100;
            overflow: visible;
        }
        
        .shift-block.multi-hour.narrow {
            padding: 4px 2px;
        }
        
        .shift-block.multi-hour:hover {
            z-index: 1000 !important;
        }
        
        .shift-block .worker-name {
            font-size: 9px;
            font-weight: 700;
            margin-bottom: 1px;
            letter-spacing: -0.3px;
            line-height: 1;
        }
        
        .shift-block.narrow .worker-name {
            font-size: 7px;
        }
        
        .shift-block .worker-type {
            font-size: 7px;
            font-weight: 500;
            opacity: 0.7;
            margin-bottom: 2px;
            line-height: 1;
        }
        
        .shift-block.narrow .worker-type {
            font-size: 6px;
        }
        
        .shift-block .time-range {
            font-size: 8px;
            font-weight: 600;
            margin: 2px 0;
            line-height: 1.1;
        }
        
        .shift-block.narrow .time-range {
            font-size: 7px;
        }
        
        .shift-block .hours-total {
            font-size: 10px;
            font-weight: 800;
            margin-top: auto;
            padding-top: 2px;
            border-top: 1px solid rgba(0,0,0,0.2);
            color: #000;
        }
        
        .shift-block.narrow .hours-total {
            font-size: 8px;
        }
        
        .shift-block .break-indicator {
            font-size: 7px;
            color: #e74c3c;
            font-weight: 600;
            margin-top: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }
        
        .shift-block.narrow .break-indicator {
            font-size: 6px;
        }
        
        .break-icon {
            font-size: 8px;
        }
        
        .shift-block.has-break {
            border-left: 3px solid #e74c3c;
        }
        
        .shift-block .resize-handle {
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 12px;
            cursor: ns-resize;
            background: transparent;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .shift-block:hover .resize-handle {
            opacity: 1;
        }
        
        .shift-block:hover .resize-handle::after {
            content: '⋮';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: rgba(0,0,0,0.4);
            font-weight: bold;
        }
        
        .shift-block.resizing {
            opacity: 0.8;
            z-index: 2000 !important;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }
        
        body.resizing {
            cursor: ns-resize !important;
            user-select: none;
        }
        
        body.resizing * {
            cursor: ns-resize !important;
        }
        
        .controls {
            padding: 15px 20px;
            background: #f8f8f8;
            border-top: 2px solid #ddd;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #2196F3;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #1976D2;
        }
        
        .btn-secondary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-success:hover {
            background: #45a049;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal h2 {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group input[type="color"] {
            height: 40px;
            cursor: pointer;
        }
        
        .availability-grid {
            display: grid;
            grid-template-columns: 100px repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .availability-header {
            font-weight: 600;
            padding: 5px;
            background: #f0f0f0;
            text-align: center;
        }
        
        .availability-input {
            padding: 5px;
        }
        
        .availability-input input {
            width: 100%;
            padding: 3px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .stats {
            padding: 10px 20px;
            background: #f0f0f0;
            display: flex;
            gap: 20px;
            font-size: 14px;
        }
        
        .stat-item {
            display: flex;
            gap: 5px;
        }
        
        .stat-label {
            font-weight: 600;
        }
        
        .legend {
            padding: 10px 20px;
            background: #f8f8f8;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 13px;
            border-top: 1px solid #ddd;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.2);
        }
        
        .worker-category.empty {
            border-style: dashed;
            background: #fafafa;
        }
        
        .category-toggles {
            background: #f0f0f0;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .category-toggles h4 {
            font-size: 12px;
            margin-bottom: 8px;
            color: #333;
            text-align: center;
        }
        
        .toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 11px;
        }
        
        .toggle-switch {
            position: relative;
            width: 34px;
            height: 18px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 18px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 12px;
            width: 12px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #2196F3;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(16px);
        }
        
        .worker-category.empty::after {
            content: 'Drag workers here';
            display: block;
            text-align: center;
            color: #aaa;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .drag-hint {
            font-size: 11px;
            color: #888;
            text-align: center;
            margin-top: 10px;
            font-style: italic;
        }
        
        .export-results {
            margin: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .export-header {
            background: #f0f0f0;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .export-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        
        .export-header .btn {
            margin-left: 10px;
        }
        
        .export-content {
            max-height: 500px;
            overflow-y: auto;
            padding: 20px;
        }
        
        .schedule-header {
            background: #f8f8f8;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            border-left: 4px solid #4CAF50;
        }
        
        .schedule-header h4 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: #333;
        }
        
        .schedule-meta {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        
        .worker-schedule {
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .worker-header {
            padding: 12px 16px;
            font-weight: 700;
            font-size: 16px;
            color: #111;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .worker-days {
            padding: 16px;
            background: rgba(255,255,255,0.9);
        }
        
        .day-schedule {
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            padding: 8px 0;
            border-bottom: 2px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
        }
        
        .day-schedule:last-of-type {
            border-bottom: none;
        }
        
        .day-name {
            font-weight: 600;
            display: inline-block;
            min-width: 110px;
            width: 110px;
            color: #333;
            flex-shrink: 0;
            white-space: nowrap;
        }
        
        .day-time {
            color: #555;
            flex: 1;
            margin-left: 10px;
        }
        
        .total-hours {
            font-weight: bold;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 3px solid rgba(0,0,0,0.3);
            background: rgba(0,0,0,0.05);
            padding: 12px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .copy-text {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-line;
            max-height: 300px;
            overflow-y: auto;
            user-select: all;
        }
    </style>
</head>
<body>
    <div class="start-screen" id="startScreen">
        <div class="start-container">
            <div class="start-header">
                <h1>🗓️ Student Worker Schedule Board</h1>
                <p class="start-subtitle">Manage student schedules with ease</p>
            </div>
            
            <div class="start-actions">
                <button class="btn-start-primary" onclick="startNew()">
                    <span class="btn-icon">✨</span>
                    <span class="btn-text">Start New Schedule</span>
                    <span class="btn-desc">Begin with sample workers and shifts</span>
                </button>
                
                <button class="btn-start-secondary" onclick="startBlank()">
                    <span class="btn-icon">🆕</span>
                    <span class="btn-text">Start Completely Blank</span>
                    <span class="btn-desc">Empty board - no sample workers or shifts</span>
                </button>
                
                <button class="btn-start-secondary" onclick="loadFromStart()">
                    <span class="btn-icon">📁</span>
                    <span class="btn-text">Load Saved State</span>
                    <span class="btn-desc">Import a previously saved schedule</span>
                </button>
            </div>
            
            <div class="start-footer">
                <p>Features: Drag & drop scheduling • Break management • Export formats • Save/load states</p>
            </div>
        </div>
        <input type="file" id="startLoadFile" accept=".json" style="display: none;">
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <div class="header">
            <h1>Student Worker Schedule Board</h1>
            <div class="header-inputs">
                <div class="header-input-group">
                    <label for="semesterInput">Semester:</label>
                    <input type="text" id="semesterInput" value="" maxlength="50" placeholder="e.g. Fall 2025">
                </div>
                <div class="header-input-group">
                    <label for="versionInput">Versioning Date:</label>
                    <input type="text" id="versionInput" value="" maxlength="50" placeholder="e.g. 8/20/25 UPDATE">
                </div>
            </div>
            <div class="subtitle" id="subtitleDisplay"></div>
            <div class="update-date" id="updateDate"></div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <span class="stat-label">Total Workers:</span>
                <span id="totalWorkers">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Paid Hours Total:</span>
                <span id="totalHours">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Paid Hours Part Time:</span>
                <span id="partTimeHours">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Paid Hours Coop:</span>
                <span id="coopHours">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Shifts w/ Breaks:</span>
                <span id="totalBreaks">0</span>
            </div>
        </div>
        
        <div class="legend" id="legend">
            <!-- Will be populated dynamically -->
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="openAddWorkerModal()">
                    + Add Worker
                </button>
                
                <div style="font-size: 11px; color: #666; text-align: center; margin-bottom: 15px; padding: 8px; background: #f0f0f0; border-radius: 4px;">
                    💡 Select worker, then click grid to add shifts<br>
                    🔄 Drag workers between categories<br>
                    📏 Drag bottom edge to resize shifts<br>
                    ⏰ Manual Entry for custom times<br>
                    ☕ Over 6 hour student shifts include 30min unpaid break<br>
                    💾 Custom filename: Edit semester/version for save names<br>
                    📄 Generate shows formatted schedules you can copy<br>
                    🎯 Add Manual Break for custom break policies
                </div>
                
                <div class="category-toggles">
                    <h4>👁️ Show Shifts On Calendar</h4>
                    <div class="toggle-item">
                        <span>🔶 Full Time Staff</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleFullTime" checked onchange="toggleCategory('fullTime')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-item">
                        <span>🔷 Co-op Students</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleCoop" checked onchange="toggleCategory('coop')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-item">
                        <span>🔵 Part Time Students</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="togglePartTime" checked onchange="toggleCategory('partTime')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-item">
                        <span>🟢 Work Study Students</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleWorkStudy" checked onchange="toggleCategory('workStudy')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="worker-category" id="fullTimeCategory">
                    <h3>🔶 Full Time Staff</h3>
                    <div id="fullTimeWorkers"></div>
                </div>
                
                <div class="worker-category" id="coopCategory">
                    <h3>🔷 Co-op Students</h3>
                    <div id="coopWorkers"></div>
                </div>
                
                <div class="worker-category" id="partTimeCategory">
                    <h3>🔵 Part Time Students</h3>
                    <div id="partTimeWorkers"></div>
                </div>
                
                <div class="worker-category" id="workStudyCategory">
                    <h3>🟢 Work Study Students</h3>
                    <div id="workStudyWorkers"></div>
                </div>
            </div>
            
            <div class="schedule-container">
                <div class="schedule-grid" id="scheduleGrid">
                    <!-- Grid will be generated by JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" id="manualEntryBtn">Manual Shift Entry</button>
            <button class="btn btn-secondary" id="manualBreakBtn">Add Manual Break</button>
            <button class="btn btn-secondary" id="clearScheduleBtn">Clear Schedule</button>
            <button class="btn btn-secondary" id="autoScheduleBtn">Auto-Schedule</button>
            <button class="btn btn-danger" id="resetAllBtn">Reset All</button>
            <button class="btn btn-primary" id="exportBtn">Generate Worker Schedules</button>
            <button class="btn btn-secondary" id="saveStateBtn">💾 Save State</button>
            <button class="btn btn-secondary" id="loadStateBtn">📁 Load State</button>
            <button class="btn btn-secondary" id="backToMenuBtn" onclick="backToMenu()">🏠 Back to Menu</button>
            <input type="file" id="loadStateFile" accept=".json" style="display: none;">
        </div>
        
        <!-- Export Results Area -->
        <div class="export-results" id="exportResults" style="display: none;">
            <div class="export-header">
                <h3>📄 Generated Worker Schedules</h3>
                <button class="btn btn-secondary" onclick="
                    const copyText = document.getElementById('copyText');
                    if (copyText) {
                        const textArea = document.createElement('textarea');
                        textArea.value = copyText.textContent;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        
                        this.textContent = '✅ Copied!';
                        this.style.background = '#4CAF50';
                        setTimeout(() => {
                            this.textContent = '📋 Copy All';
                            this.style.background = '#2196F3';
                        }, 2000);
                    }
                ">📋 Copy All</button>
                <button class="btn btn-secondary" onclick="document.getElementById('exportResults').style.display = 'none'">✕ Close</button>
            </div>
            <div class="export-content" id="exportContent">
                <!-- Generated content will appear here -->
            </div>
        </div>
    </div>
    
    <!-- Add Worker Modal -->
    <div class="modal" id="addWorkerModal">
        <div class="modal-content">
            <h2>Add New Worker</h2>
            <div class="form-group">
                <label>Name:</label>
                <input type="text" id="workerName" placeholder="Enter worker name">
            </div>
            <div class="form-group">
                <label>Type:</label>
                <select id="workerType" onchange="updateMaxHours()">
                    <option value="fullTime">Full Time Staff</option>
                    <option value="coop">Co-op Student</option>
                    <option value="partTime">Part Time Student</option>
                    <option value="workStudy">Work Study Student</option>
                </select>
            </div>
            <div class="form-group" style="display: none;">
                <label>Color:</label>
                <input type="color" id="workerColor" value="#ff9999">
            </div>
            <div class="form-group">
                <label>Max Hours per Week:</label>
                <input type="number" id="maxHours" value="40" min="0" max="50">
                <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                    Defaults: Full-time/Co-op = 40hrs, Part-time/Work-study = 20hrs (editable)
                </small>
            </div>
            <div class="form-group">
                <label>Availability (e.g., 9:00 AM-5:00 PM or leave blank if not available):</label>
                <div class="availability-grid">
                    <div class="availability-header">Day</div>
                    <div class="availability-header">Saturday</div>
                    <div class="availability-header">Monday</div>
                    <div class="availability-header">Tuesday</div>
                    <div class="availability-header">Wednesday</div>
                    <div class="availability-header">Thursday</div>
                    <div class="availability-header">Friday</div>
                    <div class="availability-header">Sunday</div>
                    
                    <div class="availability-header">Available</div>
                    <div class="availability-input"><input type="text" id="availSat" placeholder="9:00 AM-5:00 PM"></div>
                    <div class="availability-input"><input type="text" id="availMon" placeholder="9:00 AM-5:00 PM"></div>
                    <div class="availability-input"><input type="text" id="availTue" placeholder="9:00 AM-5:00 PM"></div>
                    <div class="availability-input"><input type="text" id="availWed" placeholder="9:00 AM-5:00 PM"></div>
                    <div class="availability-input"><input type="text" id="availThu" placeholder="9:00 AM-5:00 PM"></div>
                    <div class="availability-input"><input type="text" id="availFri" placeholder="9:00 AM-5:00 PM"></div>
                    <div class="availability-input"><input type="text" id="availSun" placeholder="9:00 AM-5:00 PM"></div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="addWorker()">Add Worker</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Manual Shift Entry Modal -->
    <div class="modal" id="manualShiftModal">
        <div class="modal-content">
            <h2>Manual Shift Entry</h2>
            <div class="form-group">
                <label>Worker:</label>
                <select id="shiftWorker">
                    <option value="">Select a worker...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Day:</label>
                <select id="shiftDay">
                    <option value="0">Saturday</option>
                    <option value="1">Monday</option>
                    <option value="2">Tuesday</option>
                    <option value="3">Wednesday</option>
                    <option value="4">Thursday</option>
                    <option value="5">Friday</option>
                    <option value="6">Sunday</option>
                </select>
            </div>
            <div class="form-group">
                <label>Start Time:</label>
                <input type="time" id="shiftStartTime" min="07:00" max="22:00" step="1800">
            </div>
            <div class="form-group">
                <label>End Time:</label>
                <input type="time" id="shiftEndTime" min="07:00" max="22:00" step="1800">
            </div>
            <div class="form-group">
                <label>Or enter custom times (e.g., 9:15 AM - 2:45 PM):</label>
                <input type="text" id="customTimeRange" placeholder="9:15 AM - 2:45 PM">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="addManualShift()">Add Shift</button>
                <button class="btn btn-secondary" onclick="closeManualShiftModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Manual Break Entry Modal -->
    <div class="modal" id="manualBreakModal">
        <div class="modal-content">
            <h2>Add Manual Break</h2>
            <div class="form-group">
                <label>Worker:</label>
                <select id="breakWorker">
                    <option value="">Select a worker...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Day:</label>
                <select id="breakDay">
                    <option value="0">Saturday</option>
                    <option value="1">Monday</option>
                    <option value="2">Tuesday</option>
                    <option value="3">Wednesday</option>
                    <option value="4">Thursday</option>
                    <option value="5">Friday</option>
                    <option value="6">Sunday</option>
                </select>
            </div>
            <div class="form-group">
                <label>Break Duration:</label>
                <select id="breakDuration">
                    <option value="15">15 minutes</option>
                    <option value="30" selected>30 minutes</option>
                    <option value="45">45 minutes</option>
                    <option value="60">1 hour</option>
                </select>
            </div>
            <div class="form-group">
                <label>Break Type:</label>
                <select id="breakType">
                    <option value="unpaid" selected>Unpaid Break</option>
                    <option value="paid">Paid Break</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notes (optional):</label>
                <input type="text" id="breakNotes" placeholder="e.g., Lunch break, Rest break">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="addManualBreak()">Add Break</button>
                <button class="btn btn-secondary" onclick="closeManualBreakModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        // Data storage
        let workers = [];
        let schedule = {};
        let manualBreaks = {}; // Store manual breaks: {workerId-dayIndex: {duration, type, notes}}
        let selectedWorker = null;
        let draggedShift = null;
        let draggedWorker = null;
        let categoryVisibility = {
            fullTime: true,
            coop: true,
            partTime: true,
            workStudy: true
        };
        
        // Days and times - Saturday first, Sunday last with half-hour increments
        const days = ['Saturday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Sunday'];
        const times = [
            '7:00 AM', '7:30 AM', '8:00 AM', '8:30 AM', '9:00 AM', '9:30 AM', 
            '10:00 AM', '10:30 AM', '11:00 AM', '11:30 AM', '12:00 PM', '12:30 PM',
            '1:00 PM', '1:30 PM', '2:00 PM', '2:30 PM', '3:00 PM', '3:30 PM',
            '4:00 PM', '4:30 PM', '5:00 PM', '5:30 PM', '6:00 PM', '6:30 PM',
            '7:00 PM', '7:30 PM', '8:00 PM', '8:30 PM', '9:00 PM', '9:30 PM', '10:00 PM'
        ];

        // Start screen functions
        function startNew() {
            console.log('Starting new schedule with sample data...');
            
            // Reset data and load sample data
            resetData();
            loadSampleData();
            
            // Show main app
            showMainApp();
            
            console.log('New schedule with sample data initialized successfully');
        }

        function startBlank() {
            console.log('Starting completely blank schedule...');
            
            // Reset all data (equivalent to clear all + reset all)
            resetData();
            
            // Show main app with empty state
            showMainApp();
            
            console.log('Blank schedule initialized successfully');
        }

        function loadFromStart() {
            document.getElementById('startLoadFile').click();
        }

        function backToMenu() {
            document.getElementById('exportResults').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function resetData() {
            workers = [];
            schedule = {};
            manualBreaks = {};
            selectedWorker = null;
            categoryVisibility = { fullTime: true, coop: true, partTime: true, workStudy: true };
            
            // Clear header inputs
            document.getElementById('semesterInput').value = '';
            document.getElementById('versionInput').value = '';
        }

        function showMainApp() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Initialize the app interface
            initializeGrid();
            addEventListeners();
            renderWorkers();
            renderSchedule();
            updateStats();
            updateHeaderDisplay();
            updateLegend();
        }

        function loadSampleData() {
            // Initialize with sample data from the working version
            workers = [
                {
                    id: 1,
                    name: 'Zach',
                    type: 'fullTime',
                    color: '#f4d03f',
                    maxHours: 40, // Full-time default
                    availability: {
                        Saturday: '',
                        Monday: '8:00 AM-5:00 PM',
                        Tuesday: '8:00 AM-5:00 PM',
                        Wednesday: '8:00 AM-5:00 PM',
                        Thursday: '8:00 AM-5:00 PM',
                        Friday: '8:00 AM-5:00 PM',
                        Sunday: ''
                    }
                },
                {
                    id: 2,
                    name: 'Alyssa',
                    type: 'partTime',
                    color: '#85c1e2',
                    maxHours: 20, // Part-time default
                    availability: {
                        Saturday: '',
                        Monday: '',
                        Tuesday: '9:00 AM-4:00 PM',
                        Wednesday: '9:00 AM-1:00 PM',
                        Thursday: '',
                        Friday: '10:30 AM-2:30 PM',
                        Sunday: '12:00 PM-6:00 PM'
                    }
                },
                {
                    id: 3,
                    name: 'Jasmine',
                    type: 'workStudy',
                    color: '#ec7063',
                    maxHours: 20, // Work study default
                    availability: {
                        Saturday: '',
                        Monday: '12:30 PM-5:00 PM',
                        Tuesday: '',
                        Wednesday: '1:00 PM-5:30 PM',
                        Thursday: '2:00 PM-8:00 PM',
                        Friday: '3:00 PM-8:00 PM',
                        Sunday: ''
                    }
                },
                {
                    id: 4,
                    name: 'Meet',
                    type: 'partTime',
                    color: '#ff9966',
                    maxHours: 20, // Part-time default
                    availability: {
                        Saturday: '12:00 PM-6:00 PM',
                        Monday: '5:00 PM-8:00 PM',
                        Tuesday: '3:30 PM-8:00 PM',
                        Wednesday: '5:00 PM-8:00 PM',
                        Thursday: '10:30 AM-2:30 PM',
                        Friday: '',
                        Sunday: ''
                    }
                }
            ];
            
            // Add some sample shifts to demonstrate features
            schedule = {
                // Saturday - Meet works 12PM-3PM (continuous)
                '0-10': [ // Saturday 12:00 PM
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '0-11': [ // Saturday 12:30 PM
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '0-12': [ // Saturday 1:00 PM
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '0-13': [ // Saturday 1:30 PM
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '0-14': [ // Saturday 2:00 PM
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '0-15': [ // Saturday 2:30 PM
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                
                // Sunday - Alyssa works 12PM-6PM (continuous)
                '6-10': [ // Sunday 12:00 PM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '6-11': [ // Sunday 12:30 PM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '6-12': [ // Sunday 1:00 PM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '6-13': [ // Sunday 1:30 PM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '6-14': [ // Sunday 2:00 PM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '6-15': [ // Sunday 2:30 PM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '6-16': [ // Sunday 3:00 PM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '6-17': [ // Sunday 3:30 PM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '6-18': [ // Sunday 4:00 PM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '6-19': [ // Sunday 4:30 PM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '6-20': [ // Sunday 5:00 PM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '6-21': [ // Sunday 5:30 PM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                
                // Monday - Overlapping shifts
                '1-2': [ // Monday 8:00 AM
                    {workerId: 1, workerName: 'Zach', color: '#f4d03f'}
                ],
                '1-3': [ // Monday 8:30 AM
                    {workerId: 1, workerName: 'Zach', color: '#f4d03f'}
                ],
                '1-4': [ // Monday 9:00 AM
                    {workerId: 1, workerName: 'Zach', color: '#f4d03f'}
                ],
                '1-5': [ // Monday 9:30 AM
                    {workerId: 1, workerName: 'Zach', color: '#f4d03f'}
                ],
                '1-6': [ // Monday 10:00 AM
                    {workerId: 1, workerName: 'Zach', color: '#f4d03f'}
                ],
                '1-7': [ // Monday 10:30 AM
                    {workerId: 1, workerName: 'Zach', color: '#f4d03f'}
                ],
                '1-8': [ // Monday 11:00 AM
                    {workerId: 1, workerName: 'Zach', color: '#f4d03f'}
                ],
                '1-9': [ // Monday 11:30 AM
                    {workerId: 1, workerName: 'Zach', color: '#f4d03f'}
                ],
                '1-10': [ // Monday 12:00 PM - Both Zach and Jasmine
                    {workerId: 1, workerName: 'Zach', color: '#f4d03f'},
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ],
                '1-11': [ // Monday 12:30 PM - Just Jasmine
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ],
                '1-12': [ // Monday 1:00 PM
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ],
                '1-13': [ // Monday 1:30 PM
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ],
                '1-14': [ // Monday 2:00 PM
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ],
                '1-15': [ // Monday 2:30 PM
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ],
                '1-16': [ // Monday 3:00 PM
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ],
                '1-17': [ // Monday 3:30 PM
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ],
                '1-18': [ // Monday 4:00 PM
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ],
                '1-19': [ // Monday 4:30 PM
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ],
                
                // Tuesday - Alyssa morning shift
                '2-4': [ // Tuesday 9:00 AM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '2-5': [ // Tuesday 9:30 AM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '2-6': [ // Tuesday 10:00 AM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '2-7': [ // Tuesday 10:30 AM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '2-8': [ // Tuesday 11:00 AM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                '2-9': [ // Tuesday 11:30 AM
                    {workerId: 2, workerName: 'Alyssa', color: '#85c1e2'}
                ],
                
                // Thursday - Multiple overlapping shifts
                '4-7': [ // Thursday 10:30 AM - Meet alone
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '4-8': [ // Thursday 11:00 AM - Meet alone
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '4-9': [ // Thursday 11:30 AM - Meet alone
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '4-10': [ // Thursday 12:00 PM - Meet alone
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '4-11': [ // Thursday 12:30 PM - Meet alone
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '4-12': [ // Thursday 1:00 PM - Meet alone
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '4-14': [ // Thursday 2:00 PM - Both Jasmine and Meet
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'},
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '4-15': [ // Thursday 2:30 PM - Both
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'},
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '4-16': [ // Thursday 3:00 PM - Both
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'},
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '4-17': [ // Thursday 3:30 PM - Both
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'},
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '4-18': [ // Thursday 4:00 PM - Both
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'},
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '4-19': [ // Thursday 4:30 PM - Both
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'},
                    {workerId: 4, workerName: 'Meet', color: '#ff9966'}
                ],
                '4-20': [ // Thursday 5:00 PM - Just Jasmine
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ],
                '4-21': [ // Thursday 5:30 PM - Just Jasmine
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ],
                '4-22': [ // Thursday 6:00 PM - Just Jasmine
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ],
                '4-23': [ // Thursday 6:30 PM - Just Jasmine
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ],
                '4-24': [ // Thursday 7:00 PM - Just Jasmine
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ],
                '4-25': [ // Thursday 7:30 PM - Just Jasmine
                    {workerId: 3, workerName: 'Jasmine', color: '#ec7063'}
                ]
            };
        }
        
        function toggleCategory(categoryType) {
            categoryVisibility[categoryType] = !categoryVisibility[categoryType];
            
            // Re-render schedule and stats to show/hide shifts from this category
            renderSchedule();
            updateStats();
            updateLegend();
        }
        
        function updateHeaderDisplay() {
            const semester = document.getElementById('semesterInput').value;
            const version = document.getElementById('versionInput').value;
            
            document.getElementById('subtitleDisplay').textContent = semester;
            document.getElementById('updateDate').textContent = version ? `(${version})` : '';
        }
        
        function updateDate() {
            // This function is now handled by updateHeaderDisplay
            // Keep for compatibility but don't override user inputs
        }
        
        function updateLegend() {
            const legend = document.getElementById('legend');
            legend.innerHTML = '';
            
            // Only show workers from visible categories
            workers.filter(workerItem => categoryVisibility[workerItem.type]).forEach(workerItem => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                
                const color = document.createElement('div');
                color.className = 'legend-color';
                color.style.backgroundColor = workerItem.color;
                
                const name = document.createElement('span');
                name.textContent = workerItem.name;
                
                item.appendChild(color);
                item.appendChild(name);
                legend.appendChild(item);
            });
        }
        
        function initializeGrid() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';
            
            // Empty corner cell
            const corner = document.createElement('div');
            corner.className = 'time-header';
            grid.appendChild(corner);
            
            // Day headers
            days.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = day.substr(0, 3);
                grid.appendChild(dayHeader);
            });
            
            // Time rows
            times.forEach((time, timeIndex) => {
                // Time label
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-label';
                timeLabel.textContent = time;
                grid.appendChild(timeLabel);
                
                // Day cells
                days.forEach((day, dayIndex) => {
                    const cell = document.createElement('div');
                    cell.className = 'schedule-cell';
                    cell.dataset.day = dayIndex;
                    cell.dataset.time = timeIndex;
                    cell.onclick = (e) => {
                        if (e.target === cell) {
                            toggleShift(dayIndex, timeIndex);
                        }
                    };
                    cell.ondrop = (e) => handleDrop(e, dayIndex, timeIndex);
                    cell.ondragover = (e) => e.preventDefault();
                    grid.appendChild(cell);
                });
            });
        }
        
        function generateRandomColor() {
            // Generate vibrant, distinct colors that work well for the schedule
            const hue = Math.floor(Math.random() * 360);
            const saturation = 60 + Math.floor(Math.random() * 30); // 60-90% saturation for vibrant colors
            const lightness = 45 + Math.floor(Math.random() * 25); // 45-70% lightness for good visibility
            
            // Convert HSL to hex
            const h = hue / 360;
            const s = saturation / 100;
            const l = lightness / 100;
            
            let r, g, b;
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            
            const toHex = x => {
                const hex = Math.round(x * 255).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            };
            
            return '#' + toHex(r) + toHex(g) + toHex(b);
        }
        
        function openAddWorkerModal() {
            document.getElementById('addWorkerModal').classList.add('active');
            document.getElementById('workerName').value = '';
            document.getElementById('workerColor').value = generateRandomColor();
            document.getElementById('workerType').value = 'fullTime'; // Reset to default
            updateMaxHours(); // Set default max hours based on type
        }
        
        function updateMaxHours() {
            const workerType = document.getElementById('workerType').value;
            const maxHoursField = document.getElementById('maxHours');
            
            // Set default hours based on worker type
            switch(workerType) {
                case 'fullTime':
                    maxHoursField.value = 40;
                    break;
                case 'coop':
                    maxHoursField.value = 40;
                    break;
                case 'partTime':
                    maxHoursField.value = 20;
                    break;
                case 'workStudy':
                    maxHoursField.value = 20;
                    break;
                default:
                    maxHoursField.value = 20;
            }
        }
        
        function closeModal() {
            document.getElementById('addWorkerModal').classList.remove('active');
        }
        
        function addWorker() {
            const name = document.getElementById('workerName').value.trim();
            if (!name) {
                alert('Please enter a worker name');
                return;
            }
            
            const worker = {
                id: Date.now(),
                name: name,
                type: document.getElementById('workerType').value,
                color: document.getElementById('workerColor').value,
                maxHours: parseInt(document.getElementById('maxHours').value) || 20,
                availability: {
                    Saturday: document.getElementById('availSat').value,
                    Monday: document.getElementById('availMon').value,
                    Tuesday: document.getElementById('availTue').value,
                    Wednesday: document.getElementById('availWed').value,
                    Thursday: document.getElementById('availThu').value,
                    Friday: document.getElementById('availFri').value,
                    Sunday: document.getElementById('availSun').value
                }
            };
            
            workers.push(worker);
            renderWorkers();
            closeModal();
            updateStats();
            updateLegend();
        }
        
        function deleteWorker(id) {
            if (confirm('Are you sure you want to delete this worker?')) {
                workers = workers.filter(w => w.id !== id);
                // Remove from schedule
                Object.keys(schedule).forEach(key => {
                    schedule[key] = schedule[key].filter(shift => shift.workerId !== id);
                    if (schedule[key].length === 0) {
                        delete schedule[key];
                    }
                });
                // Remove manual breaks for this worker
                Object.keys(manualBreaks).forEach(key => {
                    if (manualBreaks[key].workerId === id) {
                        delete manualBreaks[key];
                    }
                });
                renderWorkers();
                renderSchedule();
                updateStats();
                updateLegend();
            }
        }
        
        function selectWorker(id) {
            selectedWorker = workers.find(w => w.id === id);
            renderWorkers();
        }
        
        function renderWorkers() {
            const categories = {
                fullTime: document.getElementById('fullTimeWorkers'),
                coop: document.getElementById('coopWorkers'),
                partTime: document.getElementById('partTimeWorkers'),
                workStudy: document.getElementById('workStudyWorkers')
            };
            
            // Clear all categories
            Object.values(categories).forEach(cat => cat.innerHTML = '');
            
            // Set up drop zones for categories
            document.querySelectorAll('.worker-category').forEach(category => {
                category.ondragover = (e) => {
                    e.preventDefault();
                    category.classList.add('drag-over');
                };
                
                category.ondragleave = (e) => {
                    if (!category.contains(e.relatedTarget)) {
                        category.classList.remove('drag-over');
                    }
                };
                
                category.ondrop = (e) => {
                    e.preventDefault();
                    category.classList.remove('drag-over');
                    
                    if (!draggedWorker) return;
                    
                    // Determine which category was dropped on
                    let newType = null;
                    if (category.querySelector('#fullTimeWorkers')) newType = 'fullTime';
                    else if (category.querySelector('#coopWorkers')) newType = 'coop';
                    else if (category.querySelector('#partTimeWorkers')) newType = 'partTime';
                    else if (category.querySelector('#workStudyWorkers')) newType = 'workStudy';
                    
                    if (newType && draggedWorker.type !== newType) {
                        // Update worker type
                        const worker = workers.find(w => w.id === draggedWorker.id);
                        if (worker) {
                            worker.type = newType;
                            renderWorkers();
                            updateStats();
                        }
                    }
                    
                    draggedWorker = null;
                };
            });
            
            // Render workers by category
            workers.forEach(worker => {
                const div = document.createElement('div');
                div.className = 'worker-item' + (selectedWorker && selectedWorker.id === worker.id ? ' selected' : '');
                div.style.backgroundColor = worker.color + '40';
                div.style.borderLeft = `4px solid ${worker.color}`;
                div.draggable = true;
                
                // Add drag events
                div.ondragstart = (e) => {
                    draggedWorker = worker;
                    div.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                };
                
                div.ondragend = (e) => {
                    div.classList.remove('dragging');
                    document.querySelectorAll('.worker-category').forEach(cat => {
                        cat.classList.remove('drag-over');
                    });
                };
                
                div.onclick = () => selectWorker(worker.id);
                
                const info = document.createElement('div');
                info.innerHTML = `
                    <div class="worker-name">${worker.name}</div>
                    <div class="worker-hours">Max: ${worker.maxHours}h/week</div>
                `;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-worker';
                deleteBtn.textContent = '×';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteWorker(worker.id);
                };
                
                div.appendChild(info);
                div.appendChild(deleteBtn);
                
                if (categories[worker.type]) {
                    categories[worker.type].appendChild(div);
                }
            });
            
            // Mark empty categories
            Object.entries(categories).forEach(([type, container]) => {
                const category = container.parentElement;
                if (container.children.length === 0) {
                    category.classList.add('empty');
                } else {
                    category.classList.remove('empty');
                }
            });
        }
        
        function toggleShift(dayIndex, timeIndex) {
            if (!selectedWorker) {
                alert('Please select a worker first');
                return;
            }
            
            const key = `${dayIndex}-${timeIndex}`;
            
            // Initialize as array if doesn't exist
            if (!schedule[key]) {
                schedule[key] = [];
            }
            
            // Check if worker already scheduled at this time
            const existingIndex = schedule[key].findIndex(shift => shift.workerId === selectedWorker.id);
            
            if (existingIndex !== -1) {
                // Remove just this hour
                schedule[key].splice(existingIndex, 1);
                if (schedule[key].length === 0) {
                    delete schedule[key];
                }
            } else {
                // Add shift - multiple workers can be scheduled at same time
                const day = days[dayIndex];
                const availability = selectedWorker.availability[day];
                
                if (!availability && !confirm(`${selectedWorker.name} is not available at this time. Schedule anyway?`)) {
                    return;
                }
                
                schedule[key].push({
                    workerId: selectedWorker.id,
                    workerName: selectedWorker.name,
                    color: selectedWorker.color
                });
            }
            
            renderSchedule();
            updateStats();
        }
        
        function removeShiftRange(dayIndex, startTime, endTime, workerId) {
            for (let i = startTime; i <= endTime; i++) {
                const key = `${dayIndex}-${i}`;
                if (schedule[key]) {
                    schedule[key] = schedule[key].filter(s => s.workerId !== workerId);
                    if (schedule[key].length === 0) {
                        delete schedule[key];
                    }
                }
            }
            renderSchedule();
            updateStats();
        }
        
        function renderSchedule() {
            // Clear existing shift blocks and classes
            document.querySelectorAll('.shift-block').forEach(block => block.remove());
            document.querySelectorAll('.schedule-cell').forEach(cell => {
                cell.classList.remove('has-multi-hour');
            });
            
            // First pass: identify all continuous shift ranges for each worker per day
            const workerDayShifts = {};
            
            // Group all shifts by worker and day
            Object.keys(schedule).forEach(key => {
                const shifts = schedule[key];
                if (!shifts || shifts.length === 0) return;
                
                const [dayIndex, timeIndex] = key.split('-').map(Number);
                
                shifts.forEach(shift => {
                    const workerDayKey = `${shift.workerId}-${dayIndex}`;
                    if (!workerDayShifts[workerDayKey]) {
                        workerDayShifts[workerDayKey] = {
                            workerId: shift.workerId,
                            workerName: shift.workerName,
                            color: shift.color,
                            dayIndex: dayIndex,
                            timeSlots: new Set()
                        };
                    }
                    workerDayShifts[workerDayKey].timeSlots.add(timeIndex);
                });
            });
            
            // Second pass: consolidate continuous time slots into shift blocks
            const allShifts = [];
            
            Object.values(workerDayShifts).forEach(workerDay => {
                // Convert Set to sorted array
                const timeSlots = Array.from(workerDay.timeSlots).sort((a, b) => a - b);
                
                if (timeSlots.length === 0) return;
                
                // Find continuous ranges
                let currentStart = timeSlots[0];
                let currentEnd = timeSlots[0];
                
                for (let i = 1; i < timeSlots.length; i++) {
                    if (timeSlots[i] === currentEnd + 1) {
                        // Consecutive hour - extend current shift
                        currentEnd = timeSlots[i];
                    } else {
                        // Gap found - save current shift and start new one
                        allShifts.push({
                            workerId: workerDay.workerId,
                            workerName: workerDay.workerName,
                            color: workerDay.color,
                            dayIndex: workerDay.dayIndex,
                            startTime: currentStart,
                            endTime: currentEnd,
                            hours: currentEnd - currentStart + 1
                        });
                        currentStart = timeSlots[i];
                        currentEnd = timeSlots[i];
                    }
                }
                
                // Save the last shift range
                allShifts.push({
                    workerId: workerDay.workerId,
                    workerName: workerDay.workerName,
                    color: workerDay.color,
                    dayIndex: workerDay.dayIndex,
                    startTime: currentStart,
                    endTime: currentEnd,
                    hours: currentEnd - currentStart + 1  // This represents number of 30-minute slots
                });
            });
            
            // Third pass: determine overlaps for the entire day and assign consistent positions
            const dayWorkerPositions = {};
            
            // Group shifts by day - only include visible categories
            const shiftsByDay = {};
            allShifts.forEach(shift => {
                // Check visibility before grouping
                const workerInfo = workers.find(w => w.id === shift.workerId);
                if (workerInfo && categoryVisibility[workerInfo.type]) {
                    if (!shiftsByDay[shift.dayIndex]) {
                        shiftsByDay[shift.dayIndex] = [];
                    }
                    shiftsByDay[shift.dayIndex].push(shift);
                }
            });
                
            // For each day, determine all workers and assign consistent positions
            Object.keys(shiftsByDay).forEach(dayIndex => {
                const dayShifts = shiftsByDay[dayIndex]; // Already filtered for visibility
                
                // Find all unique workers for this day
                const dayWorkers = new Set();
                dayShifts.forEach(shift => {
                    dayWorkers.add(shift.workerId);
                });
                
                // Check for any overlaps between workers on this day
                let hasOverlaps = false;
                const shiftsArray = Array.from(dayShifts);
                for (let i = 0; i < shiftsArray.length; i++) {
                    for (let j = i + 1; j < shiftsArray.length; j++) {
                        const shift1 = shiftsArray[i];
                        const shift2 = shiftsArray[j];
                        
                        // Check if time ranges overlap
                        const overlaps = (
                            (shift1.startTime <= shift2.startTime && shift1.endTime >= shift2.startTime) ||
                            (shift1.startTime <= shift2.endTime && shift1.endTime >= shift2.endTime) ||
                            (shift2.startTime <= shift1.startTime && shift2.endTime >= shift1.startTime) ||
                            (shift2.startTime <= shift1.endTime && shift2.endTime >= shift1.endTime)
                        );
                        
                        if (overlaps) {
                            hasOverlaps = true;
                            break;
                        }
                    }
                    if (hasOverlaps) break;
                }
                
                // If there are overlaps, assign positions to all workers for consistent layout
                if (hasOverlaps) {
                    const sortedWorkerIds = Array.from(dayWorkers).sort((a, b) => a - b);
                    dayWorkerPositions[dayIndex] = {};
                    sortedWorkerIds.forEach((workerId, index) => {
                        dayWorkerPositions[dayIndex][workerId] = {
                            position: index,
                            total: sortedWorkerIds.length
                        };
                    });
                }
            });
            
            // Fourth pass: render all visible shift blocks with proper positioning
            allShifts.forEach(shift => {
                // Check if this worker's category is visible
                const workerInfo = workers.find(w => w.id === shift.workerId);
                if (!workerInfo || !categoryVisibility[workerInfo.type]) {
                    return; // Skip rendering this shift if category is hidden
                }
                
                const startCell = document.querySelector(
                    `.schedule-cell[data-day="${shift.dayIndex}"][data-time="${shift.startTime}"]`
                );
                
                if (!startCell) return;
                
                const block = document.createElement('div');
                block.className = 'shift-block';
                block.style.backgroundColor = shift.color;
                
                // Get worker details
                const workerTypeLabel = {
                    fullTime: 'Full Time',
                    coop: 'Co-op',
                    partTime: 'Part Time',
                    workStudy: 'Work Study'
                };
                
                // Create block content
                let blockContent = `<div class="worker-name">${shift.workerName}</div>`;
                
                if (shift.hours >= 2) {  // 2 slots = 1 hour minimum for detailed display
                    block.classList.add('multi-hour');
                    
                    // Mark all cells in range
                    for (let i = shift.startTime; i <= shift.endTime; i++) {
                        const rangeCell = document.querySelector(
                            `.schedule-cell[data-day="${shift.dayIndex}"][data-time="${i}"]`
                        );
                        if (rangeCell) {
                            rangeCell.classList.add('has-multi-hour');
                        }
                    }
                    
                    if (workerInfo) {
                        blockContent += `<div class="worker-type">(${workerTypeLabel[workerInfo.type]})</div>`;
                    }
                    
                    const endTimeDisplay = shift.endTime + 1 < times.length ? times[shift.endTime + 1] : times[shift.endTime];
                    blockContent += `<div class="time-range">${times[shift.startTime]}<br>to<br>${endTimeDisplay}</div>`;
                    
                    // Calculate actual hours (each slot is 30 minutes)
                    const actualHours = shift.hours * 0.5;
                    
                    // Check if break is required
                    let requiresBreak = false;
                    
                    // Weekend full-day rule: Saturday (0) or Sunday (6), 12PM-6PM (slots 10-21)
                    const isWeekend = shift.dayIndex === 0 || shift.dayIndex === 6;
                    const isFullWeekendShift = isWeekend && shift.startTime === 10 && shift.endTime === 21; // 12PM-6PM
                    
                    if (isFullWeekendShift) {
                        requiresBreak = true;
                    } else {
                        // Regular rule: students with 6+ hours get break (more than 6 hours = more than 12 slots)
                        requiresBreak = shift.hours > 12 && workerInfo && workerInfo.type !== 'fullTime';
                    }
                    
                    if (requiresBreak) {
                        block.classList.add('has-break');
                        const paidHours = actualHours - 0.5; // Subtract 30-minute unpaid break
                        
                        // Check for manual breaks on this worker/day
                        const manualBreakKey = `${shift.workerId}-${shift.dayIndex}`;
                        const manualBreak = manualBreaks[manualBreakKey];
                        
                        if (manualBreak) {
                            // Manual break overrides automatic break
                            const manualPaidHours = manualBreak.type === 'unpaid' ? 
                                actualHours - (manualBreak.duration / 60) : actualHours;
                            
                            blockContent += `<div class="hours-total">${manualPaidHours % 1 === 0 ? manualPaidHours : manualPaidHours.toFixed(1)}hrs paid</div>`;
                            blockContent += `<div class="break-indicator"><span class="break-icon">☕</span>${manualBreak.duration}min ${manualBreak.type}</div>`;
                            if (manualBreak.notes) {
                                blockContent += `<div class="break-indicator" style="font-size: 6px;">${manualBreak.notes}</div>`;
                            }
                        } else if (isFullWeekendShift) {
                            blockContent += `<div class="hours-total">${paidHours % 1 === 0 ? paidHours : paidHours.toFixed(1)}hrs paid</div>`;
                            blockContent += `<div class="break-indicator"><span class="break-icon">☕</span>Weekend Full Shift: 30 Min Break</div>`;
                        } else {
                            blockContent += `<div class="hours-total">${paidHours % 1 === 0 ? paidHours : paidHours.toFixed(1)}hrs paid</div>`;
                            blockContent += `<div class="break-indicator"><span class="break-icon">☕</span>30min break</div>`;
                        }
                    } else {
                        // Check for manual breaks even when no automatic break
                        const manualBreakKey = `${shift.workerId}-${shift.dayIndex}`;
                        const manualBreak = manualBreaks[manualBreakKey];
                        
                        if (manualBreak) {
                            block.classList.add('has-break');
                            const manualPaidHours = manualBreak.type === 'unpaid' ? 
                                actualHours - (manualBreak.duration / 60) : actualHours;
                            
                            blockContent += `<div class="hours-total">${manualPaidHours % 1 === 0 ? manualPaidHours : manualPaidHours.toFixed(1)}hrs paid</div>`;
                            blockContent += `<div class="break-indicator"><span class="break-icon">☕</span>${manualBreak.duration}min ${manualBreak.type}</div>`;
                            if (manualBreak.notes) {
                                blockContent += `<div class="break-indicator" style="font-size: 6px;">${manualBreak.notes}</div>`;
                            }
                        } else {
                            blockContent += `<div class="hours-total">${actualHours % 1 === 0 ? actualHours : actualHours.toFixed(1)}hrs</div>`;
                        }
                    }
                    
                    // Set height based on number of slots (each slot is 31px)
                    block.style.height = `${(shift.hours * 31) - 2}px`;
                    
                    // Set z-index higher for longer blocks
                    block.style.zIndex = 100 + shift.hours;
                } else {
                    block.style.zIndex = 50;
                }
                
                // Position based on day-wide overlaps
                if (dayWorkerPositions[shift.dayIndex] && dayWorkerPositions[shift.dayIndex][shift.workerId]) {
                    const posInfo = dayWorkerPositions[shift.dayIndex][shift.workerId];
                    const totalPositions = posInfo.total;
                    const positionIndex = posInfo.position;
                    
                    // Calculate width and position
                    let blockWidth;
                    let spacing;
                    
                    if (totalPositions === 2) {
                        blockWidth = 45;
                        spacing = 2;
                    } else if (totalPositions === 3) {
                        blockWidth = 30;
                        spacing = 1.5;
                        block.classList.add('narrow');
                    } else {
                        blockWidth = Math.floor(85 / totalPositions);
                        spacing = 1;
                        block.classList.add('narrow');
                    }
                    
                    block.style.width = `${blockWidth}%`;
                    const leftPosition = 2 + (positionIndex * (blockWidth + spacing));
                    block.style.left = `${leftPosition}%`;
                    block.style.maxWidth = totalPositions > 2 ? '70px' : '85px';
                    block.style.minWidth = '30px';
                } else {
                    // No overlaps - use full width
                    block.style.width = 'calc(100% - 6px)';
                    block.style.left = '2px';
                }
                
                block.innerHTML = blockContent;
                
                // Add resize handle
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'resize-handle';
                resizeHandle.onmousedown = (e) => startResize(e, shift.dayIndex, shift.startTime, shift.workerId, shift.hours);
                block.appendChild(resizeHandle);
                
                // Add drag and click handlers
                block.draggable = true;
                block.ondragstart = (e) => {
                    const key = `${shift.dayIndex}-${shift.startTime}`;
                    const shiftData = {
                        workerId: shift.workerId,
                        workerName: shift.workerName,
                        color: shift.color
                    };
                    handleDragStart(e, key, shiftData);
                };
                
                block.onclick = (e) => {
                    if (e.target.classList.contains('resize-handle')) return;
                    e.stopPropagation();
                    const actualHours = shift.hours * 0.5;
                    const requiresBreak = shift.hours > 12 && workerInfo && workerInfo.type !== 'fullTime'; // More than 6 hours (except full-time)
                    const paidHours = requiresBreak ? actualHours - 0.5 : actualHours;
                    
                    let hoursText = '';
                    if (requiresBreak) {
                        hoursText = `${paidHours % 1 === 0 ? paidHours : paidHours.toFixed(1)} paid hour${paidHours !== 1 ? 's' : ''} (${actualHours % 1 === 0 ? actualHours : actualHours.toFixed(1)} total with break)`;
                    } else if (actualHours > 0.5) {
                        hoursText = `${actualHours % 1 === 0 ? actualHours : actualHours.toFixed(1)} hour${actualHours !== 1 ? 's' : ''}`;
                    }
                    
                    if (confirm(`Remove ${shift.workerName} from this${hoursText ? ' ' + hoursText : ''} shift?`)) {
                        // Remove entire shift range
                        for (let i = shift.startTime; i <= shift.endTime; i++) {
                            const removeKey = `${shift.dayIndex}-${i}`;
                            if (schedule[removeKey]) {
                                schedule[removeKey] = schedule[removeKey].filter(s => s.workerId !== shift.workerId);
                                if (schedule[removeKey].length === 0) {
                                    delete schedule[removeKey];
                                }
                            }
                        }
                        renderSchedule();
                        updateStats();
                    }
                };
                
                startCell.appendChild(block);
            });
        }
        
        function handleDragStart(e, key, shift) {
            draggedShift = { key, shift };
        }
        
        function handleDrop(e, dayIndex, timeIndex) {
            e.preventDefault();
            if (!draggedShift) return;
            
            const newKey = `${dayIndex}-${timeIndex}`;
            
            // Remove from old location
            if (schedule[draggedShift.key]) {
                schedule[draggedShift.key] = schedule[draggedShift.key].filter(
                    s => s.workerId !== draggedShift.shift.workerId
                );
                if (schedule[draggedShift.key].length === 0) {
                    delete schedule[draggedShift.key];
                }
            }
            
            // Add to new location
            if (!schedule[newKey]) {
                schedule[newKey] = [];
            }
            
            // Check if already exists at new location
            if (!schedule[newKey].find(s => s.workerId === draggedShift.shift.workerId)) {
                schedule[newKey].push(draggedShift.shift);
            }
            
            draggedShift = null;
            renderSchedule();
            updateStats();
        }
        
        function startResize(e, dayIndex, startTimeIndex, workerId, currentHours) {
            e.stopPropagation();
            e.preventDefault();
            
            const startY = e.clientY;
            const currentEndTime = startTimeIndex + currentHours - 1;
            
            const worker = workers.find(w => w.id === workerId);
            const shift = schedule[`${dayIndex}-${startTimeIndex}`].find(s => s.workerId === workerId);
            
            const handleMouseMove = (e) => {
                const deltaY = e.clientY - startY;
                const slotsDelta = Math.round(deltaY / 31); // 31px per slot (half-hour)
                const newEndTime = Math.max(startTimeIndex, Math.min(times.length - 1, currentEndTime + slotsDelta));
                
                // Update the schedule
                for (let i = startTimeIndex; i < times.length; i++) {
                    const key = `${dayIndex}-${i}`;
                    
                    if (i <= newEndTime) {
                        // Add shift if not exists
                        if (!schedule[key]) {
                            schedule[key] = [];
                        }
                        if (!schedule[key].find(s => s.workerId === workerId)) {
                            schedule[key].push({
                                workerId: workerId,
                                workerName: shift.workerName,
                                color: shift.color
                            });
                        }
                    } else {
                        // Remove shift if exists
                        if (schedule[key]) {
                            schedule[key] = schedule[key].filter(s => s.workerId !== workerId);
                            if (schedule[key].length === 0) {
                                delete schedule[key];
                            }
                        }
                    }
                }
                
                renderSchedule();
                updateStats();
            };
            
            const handleMouseUp = () => {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                document.body.classList.remove('resizing');
                document.querySelectorAll('.shift-block').forEach(block => {
                    block.classList.remove('resizing');
                });
            };
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            
            // Add resizing class to body and block
            document.body.classList.add('resizing');
            e.target.parentElement.classList.add('resizing');
        }
        
        function clearSchedule() {
            if (confirm('Clear all shifts from the schedule?')) {
                schedule = {};
                renderSchedule();
                updateStats();
            }
        }
        
        function clearAllData() {
            if (confirm('This will delete all workers, shifts, and manual breaks. Are you sure?')) {
                workers = [];
                schedule = {};
                manualBreaks = {};
                selectedWorker = null;
                renderWorkers();
                renderSchedule();
                updateStats();
                updateLegend();
            }
        }
        
        function autoSchedule() {
            if (!confirm('This will create an automatic schedule based on worker availability. Continue?')) {
                return;
            }
            
            schedule = {};
            
            // Simple auto-scheduling algorithm
            workers.forEach(worker => {
                let hoursScheduled = 0;
                const maxHours = worker.maxHours;
                
                days.forEach((day, dayIndex) => {
                    if (hoursScheduled >= maxHours * 2) return; // Convert to slots
                    
                    const availability = worker.availability[day];
                    if (!availability) return;
                    
                    // Parse availability (enhanced version for half-hour slots)
                    const parts = availability.split('-');
                    if (parts.length !== 2) return;
                    
                    const startTime = parseTime(parts[0].trim());
                    const endTime = parseTime(parts[1].trim());
                    
                    for (let timeIndex = startTime; timeIndex < endTime && timeIndex < times.length; timeIndex++) {
                        if (hoursScheduled >= maxHours * 2) break; // Convert to slots
                        
                        const key = `${dayIndex}-${timeIndex}`;
                        if (!schedule[key]) {
                            schedule[key] = [];
                        }
                        
                        // Check if worker already scheduled at this time
                        if (!schedule[key].find(s => s.workerId === worker.id)) {
                            schedule[key].push({
                                workerId: worker.id,
                                workerName: worker.name,
                                color: worker.color
                            });
                            hoursScheduled++;
                        }
                    }
                });
            });
            
            renderSchedule();
            updateStats();
        }
        
        function parseTime(timeStr) {
            // Enhanced time parser - handles various formats
            const cleaned = timeStr.toUpperCase().replace(/\s+/g, ' ').trim();
            
            // Try to find exact match first
            const exactIndex = times.findIndex(t => t.toUpperCase() === cleaned);
            if (exactIndex >= 0) return exactIndex;
            
            // Parse different time formats
            let hour = 0;
            let minute = 0;
            let isPM = false;
            
            // Check for AM/PM
            if (cleaned.includes('PM')) {
                isPM = true;
            }
            
            // Remove AM/PM for parsing
            const timePart = cleaned.replace(/[AP]M/g, '').trim();
            
            // Parse time with colon (e.g., "9:30")
            if (timePart.includes(':')) {
                const parts = timePart.split(':');
                hour = parseInt(parts[0]);
                minute = parseInt(parts[1]) || 0;
            } else {
                // Parse time without colon (e.g., "930" or "9")
                hour = parseInt(timePart);
                if (timePart.length > 2) {
                    // Format like "930" or "1030"
                    hour = Math.floor(parseInt(timePart) / 100);
                    minute = parseInt(timePart) % 100;
                }
            }
            
            // Convert to 24-hour if PM
            if (isPM && hour < 12) {
                hour += 12;
            } else if (!isPM && hour === 12) {
                hour = 0;
            }
            
            // Find closest half-hour slot
            const targetMinutes = hour * 60 + minute;
            let closestIndex = 0;
            let closestDiff = Infinity;
            
            times.forEach((t, index) => {
                // Parse the time slot
                let slotHour = parseInt(t.split(':')[0]);
                const slotMinute = parseInt(t.split(':')[1]);
                const slotIsPM = t.includes('PM');
                
                if (slotIsPM && slotHour < 12) {
                    slotHour += 12;
                } else if (!slotIsPM && slotHour === 12) {
                    slotHour = 0;
                }
                
                const slotMinutes = slotHour * 60 + slotMinute;
                const diff = Math.abs(slotMinutes - targetMinutes);
                
                if (diff < closestDiff) {
                    closestDiff = diff;
                    closestIndex = index;
                }
            });
            
            return closestIndex;
        }
        
        function openManualShiftModal() {
            // Populate worker dropdown
            const workerSelect = document.getElementById('shiftWorker');
            workerSelect.innerHTML = '<option value="">Select a worker...</option>';
            
            workers.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker.id;
                option.textContent = worker.name;
                option.style.backgroundColor = worker.color + '40';
                workerSelect.appendChild(option);
            });
            
            // Reset form
            document.getElementById('shiftDay').value = '1'; // Default to Monday
            document.getElementById('shiftStartTime').value = '09:00';
            document.getElementById('shiftEndTime').value = '17:00';
            document.getElementById('customTimeRange').value = '';
            
            document.getElementById('manualShiftModal').classList.add('active');
        }
        
        function closeManualShiftModal() {
            document.getElementById('manualShiftModal').classList.remove('active');
        }
        
        function addManualShift() {
            const workerId = parseInt(document.getElementById('shiftWorker').value);
            const dayIndex = parseInt(document.getElementById('shiftDay').value);
            const customTime = document.getElementById('customTimeRange').value;
            
            if (!workerId) {
                alert('Please select a worker');
                return;
            }
            
            const worker = workers.find(w => w.id === workerId);
            if (!worker) {
                alert('Worker not found');
                return;
            }
            
            let startTimeIndex, endTimeIndex;
            
            if (customTime) {
                // Parse custom time range
                const parts = customTime.split('-').map(p => p.trim());
                if (parts.length !== 2) {
                    alert('Please enter time range as "start - end" (e.g., 9:15 AM - 2:45 PM)');
                    return;
                }
                
                startTimeIndex = parseTime(parts[0]);
                endTimeIndex = parseTime(parts[1]);
            } else {
                // Use time inputs
                const startTime = document.getElementById('shiftStartTime').value;
                const endTime = document.getElementById('shiftEndTime').value;
                
                if (!startTime || !endTime) {
                    alert('Please enter start and end times');
                    return;
                }
                
                // Convert HTML time input to our format
                const convertHTMLTime = (timeStr) => {
                    const [hour, minute] = timeStr.split(':').map(Number);
                    const isPM = hour >= 12;
                    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                    const ampm = isPM ? 'PM' : 'AM';
                    return `${displayHour}:${minute.toString().padStart(2, '0')} ${ampm}`;
                };
                
                startTimeIndex = parseTime(convertHTMLTime(startTime));
                endTimeIndex = parseTime(convertHTMLTime(endTime));
            }
            
            if (endTimeIndex <= startTimeIndex) {
                alert('End time must be after start time');
                return;
            }
            
            // Add shift for each time slot
            for (let i = startTimeIndex; i <= endTimeIndex; i++) {
                const key = `${dayIndex}-${i}`;
                if (!schedule[key]) {
                    schedule[key] = [];
                }
                
                // Check if worker already scheduled at this time
                if (!schedule[key].find(s => s.workerId === workerId)) {
                    schedule[key].push({
                        workerId: workerId,
                        workerName: worker.name,
                        color: worker.color
                    });
                }
            }
            
            renderSchedule();
            updateStats();
            closeManualShiftModal();
        }
        
        function updateStats() {
            document.getElementById('totalWorkers').textContent = workers.length;
            
            // Count total scheduled hours by worker type (each slot is 30 minutes) - account for unpaid breaks
            let totalSlots = 0;
            let partTimeSlots = 0;
            let coopSlots = 0;
            let totalBreaks = 0;
            
            // Group shifts by worker and day to detect long shifts requiring breaks
            const workerDayShifts = {};
            
            Object.keys(schedule).forEach(key => {
                const shifts = schedule[key];
                if (!shifts || shifts.length === 0) return;
                
                const [dayIndex, timeIndex] = key.split('-').map(Number);
                
                shifts.forEach(shift => {
                    const workerDayKey = `${shift.workerId}-${dayIndex}`;
                    if (!workerDayShifts[workerDayKey]) {
                        workerDayShifts[workerDayKey] = {
                            workerId: shift.workerId,
                            dayIndex: dayIndex,
                            timeSlots: new Set()
                        };
                    }
                    workerDayShifts[workerDayKey].timeSlots.add(timeIndex);
                });
            });
            
            // Calculate continuous shift blocks and count breaks by worker type
            Object.values(workerDayShifts).forEach(workerDay => {
                // Check if this worker's category is visible
                const workerInfo = workers.find(w => w.id === workerDay.workerId);
                if (!workerInfo || !categoryVisibility[workerInfo.type]) {
                    return; // Skip counting hours from hidden categories
                }
                
                const timeSlots = Array.from(workerDay.timeSlots).sort((a, b) => a - b);
                
                if (timeSlots.length === 0) return;
                
                // Find continuous ranges
                let currentStart = timeSlots[0];
                let currentEnd = timeSlots[0];
                
                for (let i = 1; i < timeSlots.length; i++) {
                    if (timeSlots[i] === currentEnd + 1) {
                        currentEnd = timeSlots[i];
                    } else {
                        // End of continuous range - check if break required
                        const rangeHours = currentEnd - currentStart + 1;
                        
                        // Add to appropriate worker type totals
                        totalSlots += rangeHours;
                        if (workerInfo.type === 'partTime') {
                            partTimeSlots += rangeHours;
                        } else if (workerInfo.type === 'coop') {
                            coopSlots += rangeHours;
                        }
                        
                        // Check for breaks
                        if (rangeHours > 12 && workerInfo && workerInfo.type !== 'fullTime') { // More than 6 hours requires break (except full-time)
                            totalBreaks += 1; // 30-minute break = 1 slot
                            // Subtract break from worker type totals
                            if (workerInfo.type === 'partTime') {
                                partTimeSlots -= 1;
                            } else if (workerInfo.type === 'coop') {
                                coopSlots -= 1;
                            }
                            totalSlots -= 1;
                        }
                        
                        // Check for manual breaks
                        const manualBreakKey = `${workerDay.workerId}-${workerDay.dayIndex}`;
                        const manualBreak = manualBreaks[manualBreakKey];
                        if (manualBreak && manualBreak.type === 'unpaid') {
                            const breakSlots = Math.ceil(manualBreak.duration / 30); // Convert minutes to slots
                            totalSlots -= breakSlots;
                            if (workerInfo.type === 'partTime') {
                                partTimeSlots -= breakSlots;
                            } else if (workerInfo.type === 'coop') {
                                coopSlots -= breakSlots;
                            }
                        }
                        
                        currentStart = timeSlots[i];
                        currentEnd = timeSlots[i];
                    }
                }
                
                // Handle the last range
                const rangeHours = currentEnd - currentStart + 1;
                
                // Add to appropriate worker type totals
                totalSlots += rangeHours;
                if (workerInfo.type === 'partTime') {
                    partTimeSlots += rangeHours;
                } else if (workerInfo.type === 'coop') {
                    coopSlots += rangeHours;
                }
                
                // Check for breaks
                if (rangeHours > 12 && workerInfo && workerInfo.type !== 'fullTime') { // More than 6 hours requires break (except full-time)
                    totalBreaks += 1; // 30-minute break = 1 slot
                    // Subtract break from worker type totals
                    if (workerInfo.type === 'partTime') {
                        partTimeSlots -= 1;
                    } else if (workerInfo.type === 'coop') {
                        coopSlots -= 1;
                    }
                    totalSlots -= 1;
                }
                
                // Check for manual breaks
                const manualBreakKey = `${workerDay.workerId}-${workerDay.dayIndex}`;
                const manualBreak = manualBreaks[manualBreakKey];
                if (manualBreak && manualBreak.type === 'unpaid') {
                    const breakSlots = Math.ceil(manualBreak.duration / 30); // Convert minutes to slots
                    totalSlots -= breakSlots;
                    if (workerInfo.type === 'partTime') {
                        partTimeSlots -= breakSlots;
                    } else if (workerInfo.type === 'coop') {
                        coopSlots -= breakSlots;
                    }
                }
            });
            
            // Convert slots to hours and update display
            const totalHours = totalSlots * 0.5;
            const partTimeHours = partTimeSlots * 0.5;
            const coopHours = coopSlots * 0.5;
            
            document.getElementById('totalHours').textContent = totalHours % 1 === 0 ? totalHours : totalHours.toFixed(1);
            document.getElementById('partTimeHours').textContent = partTimeHours % 1 === 0 ? partTimeHours : partTimeHours.toFixed(1);
            document.getElementById('coopHours').textContent = coopHours % 1 === 0 ? coopHours : coopHours.toFixed(1);
            document.getElementById('totalBreaks').textContent = totalBreaks;
        }
        
        function exportSchedule() {
            let csv = 'Day,Time,Worker,Type,Hours,Paid Hours,Break Required\n';
            
            // Group shifts by worker and day to calculate breaks
            const workerDayShifts = {};
            
            Object.keys(schedule).forEach(key => {
                const shifts = schedule[key];
                if (!shifts || shifts.length === 0) return;
                
                const [dayIndex, timeIndex] = key.split('-').map(Number);
                
                shifts.forEach(shift => {
                    const workerDayKey = `${shift.workerId}-${dayIndex}`;
                    if (!workerDayShifts[workerDayKey]) {
                        workerDayShifts[workerDayKey] = {
                            workerId: shift.workerId,
                            workerName: shift.workerName,
                            dayIndex: dayIndex,
                            timeSlots: new Set()
                        };
                    }
                    workerDayShifts[workerDayKey].timeSlots.add(timeIndex);
                });
            });
            
            // Calculate shift blocks with break info
            const exportShifts = [];
            Object.values(workerDayShifts).forEach(workerDay => {
                // Check if this worker's category is visible
                const worker = workers.find(w => w.id === workerDay.workerId);
                if (!worker || !categoryVisibility[worker.type]) {
                    return; // Skip exporting shifts from hidden categories
                }
                
                const timeSlots = Array.from(workerDay.timeSlots).sort((a, b) => a - b);
                
                if (timeSlots.length === 0) return;
                
                let currentStart = timeSlots[0];
                let currentEnd = timeSlots[0];
                
                for (let i = 1; i < timeSlots.length; i++) {
                    if (timeSlots[i] === currentEnd + 1) {
                        currentEnd = timeSlots[i];
                    } else {
                        const rangeHours = currentEnd - currentStart + 1;
                        const actualHours = rangeHours * 0.5;
                        const requiresBreak = rangeHours > 12 && worker && worker.type !== 'fullTime';
                        const paidHours = requiresBreak ? actualHours - 0.5 : actualHours;
                        
                        exportShifts.push({
                            dayIndex: workerDay.dayIndex,
                            startTime: currentStart,
                            endTime: currentEnd,
                            workerId: workerDay.workerId,
                            workerName: workerDay.workerName,
                            actualHours: actualHours,
                            paidHours: paidHours,
                            requiresBreak: requiresBreak,
                            worker: worker
                        });
                        
                        currentStart = timeSlots[i];
                        currentEnd = timeSlots[i];
                    }
                }
                
                // Handle last range
                const rangeHours = currentEnd - currentStart + 1;
                const actualHours = rangeHours * 0.5;
                const requiresBreak = rangeHours > 12 && worker && worker.type !== 'fullTime';
                const paidHours = requiresBreak ? actualHours - 0.5 : actualHours;
                
                exportShifts.push({
                    dayIndex: workerDay.dayIndex,
                    startTime: currentStart,
                    endTime: currentEnd,
                    workerId: workerDay.workerId,
                    workerName: workerDay.workerName,
                    actualHours: actualHours,
                    paidHours: paidHours,
                    requiresBreak: requiresBreak,
                    worker: worker
                });
            });
            
            // Export each shift block
            exportShifts.forEach(shift => {
                const endTimeDisplay = shift.endTime + 1 < times.length ? times[shift.endTime + 1] : times[shift.endTime];
                const timeRange = `${times[shift.startTime]} - ${endTimeDisplay}`;
                csv += `${days[shift.dayIndex]},"${timeRange}",${shift.workerName},${shift.worker ? shift.worker.type : 'Unknown'},${shift.actualHours},${shift.paidHours},${shift.requiresBreak ? 'Yes' : 'No'}\n`;
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'schedule.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function openManualBreakModal() {
            // Populate worker dropdown
            const workerSelect = document.getElementById('breakWorker');
            workerSelect.innerHTML = '<option value="">Select a worker...</option>';
            
            workers.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker.id;
                option.textContent = worker.name;
                option.style.backgroundColor = worker.color + '40';
                workerSelect.appendChild(option);
            });
            
            // Reset form
            document.getElementById('breakDay').value = '1'; // Default to Monday
            document.getElementById('breakDuration').value = '30';
            document.getElementById('breakType').value = 'unpaid';
            document.getElementById('breakNotes').value = '';
            
            document.getElementById('manualBreakModal').classList.add('active');
        }
        
        function closeManualBreakModal() {
            document.getElementById('manualBreakModal').classList.remove('active');
        }
        
        function addManualBreak() {
            const workerId = parseInt(document.getElementById('breakWorker').value);
            const dayIndex = parseInt(document.getElementById('breakDay').value);
            const duration = parseInt(document.getElementById('breakDuration').value);
            const type = document.getElementById('breakType').value;
            const notes = document.getElementById('breakNotes').value;
            
            if (!workerId) {
                alert('Please select a worker');
                return;
            }
            
            const worker = workers.find(w => w.id === workerId);
            if (!worker) {
                alert('Worker not found');
                return;
            }
            
            // Check if worker has a shift on this day
            const hasShiftOnDay = Object.keys(schedule).some(key => {
                const [scheduleDayIndex] = key.split('-').map(Number);
                const shifts = schedule[key];
                return scheduleDayIndex === dayIndex && shifts && shifts.some(s => s.workerId === workerId);
            });
            
            if (!hasShiftOnDay) {
                if (!confirm(`${worker.name} doesn't appear to have a shift on ${days[dayIndex]}. Add break anyway?`)) {
                    return;
                }
            }
            
            const breakKey = `${workerId}-${dayIndex}`;
            manualBreaks[breakKey] = {
                workerId: workerId,
                workerName: worker.name,
                dayIndex: dayIndex,
                duration: duration,
                type: type,
                notes: notes,
                id: Date.now() // For tracking
            };
            
            // Re-render schedule to show break indicators
            renderSchedule();
            closeManualBreakModal();
            
            alert(`Added ${duration} minute ${type} break for ${worker.name} on ${days[dayIndex]}`);
        }
        
        function saveState() {
            const currentDate = new Date();
            const timestamp = `${currentDate.getMonth() + 1}-${currentDate.getDate()}-${currentDate.getFullYear().toString().substr(-2)}_${currentDate.getHours().toString().padStart(2, '0')}-${currentDate.getMinutes().toString().padStart(2, '0')}`;
            
            const semester = document.getElementById('semesterInput').value;
            const version = document.getElementById('versionInput').value;
            
            const state = {
                version: '1.0',
                timestamp: currentDate.toISOString(),
                semester: semester,
                versionDate: version,
                workers: workers,
                schedule: schedule,
                manualBreaks: manualBreaks,
                categoryVisibility: categoryVisibility,
                selectedWorkerId: selectedWorker ? selectedWorker.id : null,
                metadata: {
                    totalWorkers: workers.length,
                    totalShifts: Object.keys(schedule).length,
                    totalManualBreaks: Object.keys(manualBreaks).length,
                    exportedBy: 'Student Worker Schedule Board'
                }
            };
            
            // Create filename from semester and version
            const sanitizeName = (str) => str.replace(/[^a-zA-Z0-9\s\-\_]/g, '').replace(/\s+/g, '-');
            let filename = 'schedule';
            
            if (semester) {
                filename += `-${sanitizeName(semester)}`;
            }
            if (version) {
                filename += `-${sanitizeName(version)}`;
            }
            filename += `-${timestamp}.json`;
            
            const jsonString = JSON.stringify(state, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
            
            // Show success message
            const originalText = document.getElementById('saveStateBtn').textContent;
            document.getElementById('saveStateBtn').textContent = '✅ Saved!';
            document.getElementById('saveStateBtn').style.background = '#4CAF50';
            setTimeout(() => {
                document.getElementById('saveStateBtn').textContent = originalText;
                document.getElementById('saveStateBtn').style.background = '#2196F3';
            }, 2000);
        }
        
        function loadState(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const state = JSON.parse(e.target.result);
                    
                    // Validate state structure  
                    if (!state.workers || !state.schedule) {
                        alert('Invalid state file format. Please select a valid schedule state JSON file.');
                        return;
                    }
                    
                    // Confirm before loading
                    const loadTime = new Date(state.timestamp).toLocaleDateString();
                    const semesterInfo = state.semester ? ` (${state.semester})` : '';
                    const versionInfo = state.versionDate ? ` - ${state.versionDate}` : '';
                    const displayTitle = (state.semester || state.versionDate) ? `${semesterInfo}${versionInfo}` : ' (No title set)';
                    const confirmMsg = `Load schedule state from ${loadTime}${displayTitle}?\n\n` +
                                     `Workers: ${state.metadata?.totalWorkers || state.workers.length}\n` +
                                     `Shifts: ${state.metadata?.totalShifts || Object.keys(state.schedule).length}\n\n` +
                                     `This will replace your current work.`;
                    
                    if (!confirm(confirmMsg)) return;
                    
                    // Restore state
                    workers = state.workers || [];
                    schedule = state.schedule || {};
                    manualBreaks = state.manualBreaks || {};
                    categoryVisibility = state.categoryVisibility || {
                        fullTime: true,
                        coop: true,
                        partTime: true,
                        workStudy: true
                    };
                    
                    // Restore header values
                    document.getElementById('semesterInput').value = state.semester || '';
                    document.getElementById('versionInput').value = state.versionDate || '';
                    updateHeaderDisplay();
                    
                    // Restore selected worker
                    selectedWorker = null;
                    if (state.selectedWorkerId) {
                        selectedWorker = workers.find(w => w.id === state.selectedWorkerId);
                    }
                    
                    // If loading from start screen, show main app and initialize
                    const isFromStartScreen = document.getElementById('startScreen').style.display !== 'none';
                    if (isFromStartScreen) {
                        document.getElementById('startScreen').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        initializeGrid(); // Initialize grid when coming from start screen
                        addEventListeners();
                    }
                    
                    // Update category toggles
                    document.getElementById('toggleFullTime').checked = categoryVisibility.fullTime;
                    document.getElementById('toggleCoop').checked = categoryVisibility.coop;
                    document.getElementById('togglePartTime').checked = categoryVisibility.partTime;
                    document.getElementById('toggleWorkStudy').checked = categoryVisibility.workStudy;
                    
                    // Re-render everything
                    renderWorkers();
                    renderSchedule();
                    updateStats();
                    updateDate();
                    updateLegend();
                    
                    // Show success message
                    const originalText = document.getElementById('loadStateBtn').textContent;
                    document.getElementById('loadStateBtn').textContent = '✅ Loaded!';
                    document.getElementById('loadStateBtn').style.background = '#4CAF50';
                    setTimeout(() => {
                        document.getElementById('loadStateBtn').textContent = originalText;
                        document.getElementById('loadStateBtn').style.background = '#2196F3';
                    }, 2000);
                    
                } catch (error) {
                    alert('Error loading state file. Please check the file format and try again.\n\nError: ' + error.message);
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function addEventListeners() {
            if (window.listenersAdded) return;
            
            console.log('Adding event listeners...');
            
            document.getElementById('clearScheduleBtn').addEventListener('click', clearSchedule);
            document.getElementById('autoScheduleBtn').addEventListener('click', autoSchedule);
            document.getElementById('resetAllBtn').addEventListener('click', clearAllData);
            document.getElementById('manualEntryBtn').addEventListener('click', openManualShiftModal);
            document.getElementById('manualBreakBtn').addEventListener('click', openManualBreakModal);
            document.getElementById('saveStateBtn').addEventListener('click', saveState);
            document.getElementById('loadStateBtn').addEventListener('click', () => document.getElementById('loadStateFile').click());
            document.getElementById('loadStateFile').addEventListener('change', loadState);
            
            // Header input listeners
            document.getElementById('semesterInput').addEventListener('input', updateHeaderDisplay);
            document.getElementById('versionInput').addEventListener('input', updateHeaderDisplay);
            
            // Export button - define the function inline to ensure it works
            document.getElementById('exportBtn').addEventListener('click', function() {
                console.log('Generating full worker schedules...');
                
                const exportResults = document.getElementById('exportResults');
                const exportContent = document.getElementById('exportContent');
                
                // Build schedule data
                const workerSchedules = {};
                
                // Initialize each visible worker
                workers.filter(w => categoryVisibility[w.type]).forEach(worker => {
                    workerSchedules[worker.id] = {
                        name: worker.name,
                        type: worker.type,
                        color: worker.color,
                        schedule: {
                            Monday: [],
                            Tuesday: [],
                            Wednesday: [], 
                            Thursday: [],
                            Friday: [],
                            Saturday: [],
                            Sunday: []
                        }
                    };
                });
                
                // Group all shifts by worker and day
                const workerDayShifts = {};
                Object.keys(schedule).forEach(key => {
                    const shifts = schedule[key];
                    if (!shifts || shifts.length === 0) return;
                    
                    const [dayIndex, timeIndex] = key.split('-').map(Number);
                    
                    shifts.forEach(shift => {
                        const worker = workers.find(w => w.id === shift.workerId);
                        if (!worker || !categoryVisibility[worker.type]) return;
                        
                        const workerDayKey = `${shift.workerId}-${dayIndex}`;
                        if (!workerDayShifts[workerDayKey]) {
                            workerDayShifts[workerDayKey] = {
                                workerId: shift.workerId,
                                workerName: shift.workerName,
                                dayIndex: dayIndex,
                                timeSlots: new Set()
                            };
                        }
                        workerDayShifts[workerDayKey].timeSlots.add(timeIndex);
                    });
                });
                
                // Process continuous shift blocks for each worker per day
                Object.values(workerDayShifts).forEach(workerDay => {
                    const timeSlots = Array.from(workerDay.timeSlots).sort((a, b) => a - b);
                    const dayName = days[workerDay.dayIndex];
                    
                    if (timeSlots.length === 0 || !workerSchedules[workerDay.workerId]) return;
                    
                    // Find continuous ranges
                    let currentStart = timeSlots[0];
                    let currentEnd = timeSlots[0];
                    
                    for (let i = 1; i < timeSlots.length; i++) {
                        if (timeSlots[i] === currentEnd + 1) {
                            currentEnd = timeSlots[i];
                        } else {
                            // Save current shift range
                            const hours = currentEnd - currentStart + 1;
                            const actualHours = hours * 0.5;
                            const worker = workers.find(w => w.id === workerDay.workerId);
                            
                            // Check if break required
                            let requiresBreak = false;
                            
                            // Weekend full-day rule: 12PM-6PM (index 10-21) gets break regardless of worker type
                            const isWeekend = workerDay.dayIndex === 0 || workerDay.dayIndex === 6; // Saturday or Sunday
                            const isFullWeekendShift = isWeekend && currentStart === 10 && currentEnd === 21; // 12PM-6PM
                            
                            if (isFullWeekendShift) {
                                requiresBreak = true;
                            } else {
                                // Regular rule: students with 6+ hours get break
                                requiresBreak = hours > 12 && worker && worker.type !== 'fullTime';
                            }
                            
                            const paidHours = requiresBreak ? actualHours - 0.5 : actualHours;
                            
                            // Check for manual breaks on this day
                            const manualBreakKey = `${workerDay.workerId}-${workerDay.dayIndex}`;
                            const manualBreak = manualBreaks[manualBreakKey];
                            
                            let finalPaidHours = paidHours;
                            let breakInfo = { requiresBreak, isManual: false, manualBreak: null };
                            
                            if (manualBreak) {
                                if (manualBreak.type === 'unpaid') {
                                    finalPaidHours = actualHours - (manualBreak.duration / 60);
                                } else {
                                    finalPaidHours = actualHours; // Paid breaks don't reduce hours
                                }
                                breakInfo = { 
                                    requiresBreak: true, 
                                    isManual: true, 
                                    manualBreak: manualBreak 
                                };
                            }
                            
                            const startTime = times[currentStart];
                            const endTime = currentEnd + 1 < times.length ? times[currentEnd + 1] : times[currentEnd];
                            
                            workerSchedules[workerDay.workerId].schedule[dayName].push({
                                timeRange: `${startTime}-${endTime}`,
                                hours: finalPaidHours,
                                requiresBreak: breakInfo.requiresBreak,
                                isManualBreak: breakInfo.isManual,
                                manualBreak: breakInfo.manualBreak,
                                isWeekendFullShift: isFullWeekendShift
                            });
                            
                            currentStart = timeSlots[i];
                            currentEnd = timeSlots[i];
                        }
                    }
                    
                    // Save the last shift range
                    const hours = currentEnd - currentStart + 1;
                    const actualHours = hours * 0.5;
                    const worker = workers.find(w => w.id === workerDay.workerId);
                    
                    // Check if break required
                    let requiresBreak = false;
                    
                    // Weekend full-day rule: 12PM-6PM (index 10-21) gets break regardless of worker type
                    const isWeekend = workerDay.dayIndex === 0 || workerDay.dayIndex === 6; // Saturday or Sunday
                    const isFullWeekendShift = isWeekend && currentStart === 10 && currentEnd === 21; // 12PM-6PM
                    
                    if (isFullWeekendShift) {
                        requiresBreak = true;
                    } else {
                        // Regular rule: students with 6+ hours get break
                        requiresBreak = hours > 12 && worker && worker.type !== 'fullTime';
                    }
                    
                    const paidHours = requiresBreak ? actualHours - 0.5 : actualHours;
                    
                    // Check for manual breaks on this day
                    const manualBreakKey = `${workerDay.workerId}-${workerDay.dayIndex}`;
                    const manualBreak = manualBreaks[manualBreakKey];
                    
                    let finalPaidHours = paidHours;
                    let breakInfo = { requiresBreak, isManual: false, manualBreak: null };
                    
                    if (manualBreak) {
                        if (manualBreak.type === 'unpaid') {
                            finalPaidHours = actualHours - (manualBreak.duration / 60);
                        } else {
                            finalPaidHours = actualHours; // Paid breaks don't reduce hours
                        }
                        breakInfo = { 
                            requiresBreak: true, 
                            isManual: true, 
                            manualBreak: manualBreak 
                        };
                    }
                    
                    const startTime = times[currentStart];
                    const endTime = currentEnd + 1 < times.length ? times[currentEnd + 1] : times[currentEnd];
                    
                    workerSchedules[workerDay.workerId].schedule[dayName].push({
                        timeRange: `${startTime}-${endTime}`,
                        hours: finalPaidHours,
                        requiresBreak: breakInfo.requiresBreak,
                        isManualBreak: breakInfo.isManual,
                        manualBreak: breakInfo.manualBreak,
                        isWeekendFullShift: isFullWeekendShift
                    });
                });
                
                // Generate HTML content
                let htmlContent = '';
                
                // Header section
                const semester = document.getElementById('semesterInput').value;
                const version = document.getElementById('versionInput').value;
                
                htmlContent += '<div class="schedule-header">';
                htmlContent += '<h4>📋 STUDENT WORKER SCHEDULE</h4>';
                if (semester) htmlContent += `<div class="schedule-meta">Semester: ${semester}</div>`;
                if (version) htmlContent += `<div class="schedule-meta">Version: ${version}</div>`;
                htmlContent += '</div>';
                
                // Sort workers by name
                const sortedWorkers = Object.values(workerSchedules).sort((a, b) => a.name.localeCompare(b.name));
                
                // Generate worker schedules
                sortedWorkers.forEach(worker => {
                    // Lighten the worker color for background
                    const lightColor = worker.color + '30'; // Add transparency
                    const darkColor = worker.color + 'CC'; // Darker version for header
                    
                    htmlContent += `<div class="worker-schedule">`;
                    htmlContent += `<div class="worker-header" style="background: ${darkColor};">${worker.name} Schedule</div>`;
                    htmlContent += `<div class="worker-days" style="background: ${lightColor};">`;
                    
                    // Calculate total hours for this worker
                    let totalWeeklyHours = 0;
                    
                    ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].forEach(day => {
                        const dayShifts = worker.schedule[day];
                        htmlContent += '<div class="day-schedule">';
                        htmlContent += `<span class="day-name">• ${day}:</span>`;
                        
                        if (dayShifts.length === 0) {
                            htmlContent += '<span class="day-time">Off</span>';
                        } else {
                            const shiftStrings = dayShifts.map(shift => {
                                let shiftText = shift.timeRange;
                                if (shift.hours > 0) {
                                    const hoursText = shift.hours % 1 === 0 ? shift.hours : shift.hours.toFixed(1);
                                    shiftText += ` (${hoursText} Hour${shift.hours !== 1 ? 's' : ''}`;
                                    
                                    if (shift.requiresBreak) {
                                        if (shift.isManualBreak) {
                                            const breakDuration = shift.manualBreak.duration;
                                            shiftText += ` + ${breakDuration} Min ${shift.manualBreak.type.charAt(0).toUpperCase() + shift.manualBreak.type.slice(1)} Break`;
                                            if (shift.manualBreak.notes) {
                                                shiftText += ` (${shift.manualBreak.notes})`;
                                            }
                                        } else if (shift.isWeekendFullShift) {
                                            shiftText += ' + 30 Minute Break';
                                        } else {
                                            shiftText += ' + 30 Minute Break';
                                        }
                                    }
                                    shiftText += ')';
                                    
                                    // Add to total (paid hours only)
                                    totalWeeklyHours += shift.hours;
                                }
                                return shiftText;
                            });
                            htmlContent += `<span class="day-time">${shiftStrings.join(', ')}</span>`;
                        }
                        htmlContent += '</div>';
                    });
                    
                    // Add total hours with new styling
                    const totalHoursText = totalWeeklyHours % 1 === 0 ? totalWeeklyHours : totalWeeklyHours.toFixed(1);
                    htmlContent += `<div class="total-hours">`;
                    htmlContent += `<span>TOTAL:</span> <span>${totalHoursText} Hours Per Week</span>`;
                    htmlContent += '</div>';
                    
                    htmlContent += '</div></div>';
                });
                
                // Generate plain text for copying
                let textOutput = 'STUDENT WORKER SCHEDULE\n========================\n\n';
                if (semester) textOutput += `Semester: ${semester}\n`;
                if (version) textOutput += `Version: ${version}\n`;
                if (semester || version) textOutput += '\n';
                
                sortedWorkers.forEach((worker, index) => {
                    if (index > 0) textOutput += '\n';
                    textOutput += `${worker.name} Schedule\n`;
                    
                    // Calculate total hours for this worker
                    let totalWeeklyHours = 0;
                    
                    ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].forEach(day => {
                        const dayShifts = worker.schedule[day];
                        textOutput += `• ${day}: `;
                        
                        if (dayShifts.length === 0) {
                            textOutput += 'Off\n';
                        } else {
                            const shiftStrings = dayShifts.map(shift => {
                                let shiftText = shift.timeRange;
                                if (shift.hours > 0) {
                                    const hoursText = shift.hours % 1 === 0 ? shift.hours : shift.hours.toFixed(1);
                                    shiftText += ` (${hoursText} Hour${shift.hours !== 1 ? 's' : ''}`;
                                    
                                    if (shift.requiresBreak) {
                                        if (shift.isManualBreak) {
                                            const breakDuration = shift.manualBreak.duration;
                                            shiftText += ` + ${breakDuration} Min ${shift.manualBreak.type.charAt(0).toUpperCase() + shift.manualBreak.type.slice(1)} Break`;
                                            if (shift.manualBreak.notes) {
                                                shiftText += ` (${shift.manualBreak.notes})`;
                                            }
                                        } else if (shift.isWeekendFullShift) {
                                            shiftText += ' + 30 Minute Break';
                                        } else {
                                            shiftText += ' + 30 Minute Break';
                                        }
                                    }
                                    shiftText += ')';
                                    
                                    // Add to total (paid hours only)
                                    totalWeeklyHours += shift.hours;
                                }
                                return shiftText;
                            });
                            textOutput += shiftStrings.join(', ') + '\n';
                        }
                    });
                    
                    // Add total hours
                    const totalHoursText = totalWeeklyHours % 1 === 0 ? totalWeeklyHours : totalWeeklyHours.toFixed(1);
                    textOutput += `TOTAL: ${totalHoursText} Hours Per Week\n`;
                });
                
                // Add copy-friendly text area
                htmlContent += `<div class="copy-text" id="copyText">${textOutput}</div>`;
                
                // Show the results
                exportContent.innerHTML = htmlContent;
                exportResults.style.display = 'block';
                exportResults.scrollIntoView({ behavior: 'smooth' });
            });
            
            // Make functions available globally
            window.toggleCategory = toggleCategory;
            window.openManualBreakModal = openManualBreakModal;
            window.closeManualBreakModal = closeManualBreakModal;
            window.addManualBreak = addManualBreak;
            window.updateMaxHours = updateMaxHours;
            
            window.listenersAdded = true;
            console.log('Event listeners added successfully');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('startScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            // Add load state listener for start screen
            document.getElementById('startLoadFile').addEventListener('change', loadState);
        });
    </script>
</body>
</html>
